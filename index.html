<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C# Selenium Testing Quiz</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --green: #10b981;
    --red: #ef4444;
    --yellow: #f59e0b;
    --text: #e2e8f0;
    --muted: #64748b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem;
    background-image:
      radial-gradient(ellipse at 20% 10%, rgba(0,212,255,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 90%, rgba(124,58,237,0.08) 0%, transparent 50%);
  }

  /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
  .auth-wrapper {
    width: 100%;
    max-width: 440px;
    margin-top: 4rem;
    animation: slideIn 0.4s ease;
  }

  .auth-logo {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .auth-logo h1 {
    font-size: 2.2rem;
    font-weight: 800;
    letter-spacing: -1px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .auth-logo p {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
    color: var(--muted);
    margin-top: 0.3rem;
  }

  .auth-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
  }

  .auth-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.8rem;
  }

  .auth-tab {
    flex: 1;
    padding: 0.6rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .auth-tab.active {
    background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(124,58,237,0.15));
    border-color: var(--accent);
    color: var(--accent);
  }

  .form-group {
    margin-bottom: 1.1rem;
  }

  .form-group label {
    display: block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 0.4rem;
  }

  .form-group input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    padding: 0.75rem 1rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-group input:focus { border-color: var(--accent); }
  .form-group input::placeholder { color: var(--muted); }

  .auth-btn {
    width: 100%;
    padding: 0.85rem;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 10px;
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: opacity 0.2s, transform 0.15s;
  }

  .auth-btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .auth-error {
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.3);
    border-radius: 8px;
    color: var(--red);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    padding: 0.7rem 1rem;
    margin-top: 1rem;
    display: none;
  }

  .auth-success {
    background: rgba(16,185,129,0.1);
    border: 1px solid rgba(16,185,129,0.3);
    border-radius: 8px;
    color: var(--green);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    padding: 0.7rem 1rem;
    margin-top: 1rem;
    display: none;
  }

  /* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
  .app-wrapper {
    width: 100%;
    max-width: 780px;
    display: none;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header-left h1 {
    font-size: clamp(1.4rem, 3vw, 2rem);
    font-weight: 800;
    letter-spacing: -1px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header-left p {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 0.2rem;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .user-badge {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.4rem 0.8rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
  }

  .user-badge span { color: var(--accent); }

  .logout-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-family: 'Syne', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    padding: 0.4rem 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .logout-btn:hover { border-color: var(--red); color: var(--red); }

  /* History panel */
  .history-toggle {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--muted);
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    padding: 0.6rem 1rem;
    cursor: pointer;
    margin-bottom: 1.5rem;
    width: 100%;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
  }

  .history-toggle:hover { border-color: var(--accent); color: var(--accent); }

  .history-panel {
    display: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    animation: slideIn 0.3s ease;
  }

  .history-panel.open { display: block; }

  .history-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.2rem;
  }

  .history-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
  }

  .history-card .hc-level {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 0.6rem;
  }

  .history-card.basic .hc-level { color: var(--green); }
  .history-card.intermediate .hc-level { color: var(--yellow); }
  .history-card.advanced .hc-level { color: var(--red); }

  .history-card .hc-best {
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--text);
    line-height: 1;
  }

  .history-card .hc-avg {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    margin-top: 0.3rem;
  }

  .history-card .hc-attempts {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    margin-top: 0.2rem;
  }

  .recent-attempts h3 {
    font-size: 0.8rem;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 0.75rem;
  }

  .attempt-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
  }

  .attempt-row:last-child { border-bottom: none; }

  .attempt-level {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
  }

  .attempt-level.basic { background: rgba(16,185,129,0.15); color: var(--green); }
  .attempt-level.intermediate { background: rgba(245,158,11,0.15); color: var(--yellow); }
  .attempt-level.advanced { background: rgba(239,68,68,0.15); color: var(--red); }

  .attempt-score { font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
  .attempt-date { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--muted); }

  .no-history {
    text-align: center;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.82rem;
    padding: 1rem 0;
  }

  /* ‚îÄ‚îÄ LEVEL SELECTOR ‚îÄ‚îÄ */
  .level-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .level-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 1.2rem 1rem;
    border-radius: 12px;
    cursor: pointer;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .level-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .level-btn.basic::before { background: linear-gradient(135deg, rgba(16,185,129,0.15), transparent); }
  .level-btn.intermediate::before { background: linear-gradient(135deg, rgba(245,158,11,0.15), transparent); }
  .level-btn.advanced::before { background: linear-gradient(135deg, rgba(239,68,68,0.15), transparent); }

  .level-btn:hover::before, .level-btn.active::before { opacity: 1; }
  .level-btn.basic { border-color: rgba(16,185,129,0.3); }
  .level-btn.intermediate { border-color: rgba(245,158,11,0.3); }
  .level-btn.advanced { border-color: rgba(239,68,68,0.3); }
  .level-btn.active.basic { border-color: var(--green); box-shadow: 0 0 20px rgba(16,185,129,0.2); }
  .level-btn.active.intermediate { border-color: var(--yellow); box-shadow: 0 0 20px rgba(245,158,11,0.2); }
  .level-btn.active.advanced { border-color: var(--red); box-shadow: 0 0 20px rgba(239,68,68,0.2); }
  .level-icon { font-size: 1.5rem; display: block; margin-bottom: 0.3rem; }
  .level-label { font-size: 0.75rem; opacity: 0.6; font-weight: 400; font-family: 'JetBrains Mono', monospace; }

  /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
  .progress-bar-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    height: 6px;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 8px;
    transition: width 0.4s ease;
    width: 0%;
  }

  .progress-info {
    display: flex;
    justify-content: space-between;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }

  /* ‚îÄ‚îÄ QUESTION CARD ‚îÄ‚îÄ */
  .question-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 1rem;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .question-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 0.75rem;
  }

  .question-text { font-size: 1.1rem; font-weight: 700; line-height: 1.5; margin-bottom: 1.5rem; }

  .code-block {
    background: #0d1117;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem 1.2rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.82rem;
    color: #a9c3e3;
    margin-bottom: 1.5rem;
    overflow-x: auto;
    line-height: 1.7;
    white-space: pre;
  }

  .options { display: flex; flex-direction: column; gap: 0.65rem; }

  .option-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    padding: 0.9rem 1.2rem;
    text-align: left;
    cursor: pointer;
    font-family: 'Syne', sans-serif;
    font-size: 0.95rem;
    transition: all 0.18s;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .option-btn:hover:not(:disabled) {
    border-color: var(--accent);
    background: rgba(0,212,255,0.05);
    transform: translateX(4px);
  }

  .option-btn .opt-label {
    background: var(--border);
    color: var(--muted);
    border-radius: 6px;
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem; font-weight: 700;
    flex-shrink: 0;
    transition: all 0.18s;
  }

  .option-btn.correct { border-color: var(--green); background: rgba(16,185,129,0.1); }
  .option-btn.correct .opt-label { background: var(--green); color: #000; }
  .option-btn.wrong { border-color: var(--red); background: rgba(239,68,68,0.08); }
  .option-btn.wrong .opt-label { background: var(--red); color: #fff; }
  .option-btn:disabled { cursor: default; }

  .explanation {
    margin-top: 1.2rem;
    padding: 1.1rem 1.3rem;
    border-radius: 10px;
    font-size: 0.92rem;
    line-height: 1.6;
    animation: fadeIn 0.3s ease;
    display: none;
  }

  .explanation.show { display: block; }
  .explanation.correct-exp { background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.3); }
  .explanation.wrong-exp { background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.2); }
  .explanation strong { color: var(--accent); }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .next-btn {
    width: 100%;
    margin-top: 1rem;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 10px;
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    padding: 0.9rem;
    cursor: pointer;
    display: none;
    transition: opacity 0.2s, transform 0.15s;
  }

  .next-btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .next-btn.show { display: block; animation: fadeIn 0.3s ease; }

  /* ‚îÄ‚îÄ SCORE SCREEN ‚îÄ‚îÄ */
  .score-screen {
    display: none;
    text-align: center;
    padding: 3rem 2rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    animation: slideIn 0.4s ease;
  }

  .score-screen.show { display: block; }

  .score-number {
    font-size: 5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
  }

  .score-label { color: var(--muted); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; margin-top: 0.5rem; }
  .score-msg { font-size: 1.2rem; font-weight: 700; margin: 1.5rem 0 0.5rem; }
  .score-sub { color: var(--muted); font-size: 0.9rem; }
  .score-saved { color: var(--green); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; margin-top: 0.75rem; }

  .score-actions { display: flex; gap: 0.75rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap; }

  .restart-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.95rem;
    padding: 0.8rem 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .restart-btn:hover { border-color: var(--accent); color: var(--accent); }

  .start-screen {
    text-align: center;
    padding: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .start-screen p { color: var(--muted); line-height: 1.7; font-size: 0.95rem; }

  .badge {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    margin: 0.2rem;
  }

  .badge.b { background: rgba(16,185,129,0.15); color: var(--green); border: 1px solid rgba(16,185,129,0.3); }
  .badge.i { background: rgba(245,158,11,0.15); color: var(--yellow); border: 1px solid rgba(245,158,11,0.3); }
  .badge.a { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }

  .loading-spinner {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin-right: 6px;
    vertical-align: middle;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ -->
<div class="auth-wrapper" id="authScreen">
  <div class="auth-logo">
    <h1>C# Selenium Quiz</h1>
    <p>// testing frameworks &amp; automation mastery</p>
  </div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" id="loginTab" onclick="switchTab('login')">Sign In</button>
      <button class="auth-tab" id="signupTab" onclick="switchTab('signup')">Create Account</button>
    </div>

    <!-- Login form -->
    <div id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="you@example.com" />
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter') handleLogin()" />
      </div>
      <button class="auth-btn" id="loginBtn" onclick="handleLogin()">Sign In</button>
      <div class="auth-error" id="loginError"></div>
    </div>

    <!-- Signup form -->
    <div id="signupForm" style="display:none">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="signupEmail" placeholder="you@example.com" />
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="signupPassword" placeholder="Min. 6 characters" />
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="signupConfirm" placeholder="Repeat password" onkeydown="if(event.key==='Enter') handleSignup()" />
      </div>
      <button class="auth-btn" id="signupBtn" onclick="handleSignup()">Create Account</button>
      <div class="auth-error" id="signupError"></div>
      <div class="auth-success" id="signupSuccess"></div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ -->
<div class="app-wrapper" id="appScreen">

  <header>
    <div class="header-left">
      <h1>C# Selenium Quiz</h1>
      <p>// testing frameworks &amp; automation mastery</p>
    </div>
    <div class="header-right">
      <div class="user-badge">üë§ <span id="userEmail"></span></div>
      <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
    </div>
  </header>

  <!-- History toggle -->
  <button class="history-toggle" onclick="toggleHistory()">
    <span>üìä My Results History</span>
    <span id="historyArrow">‚ñº</span>
  </button>

  <div class="history-panel" id="historyPanel">
    <div class="history-grid" id="historyGrid">
      <div class="history-card basic">
        <div class="hc-level">Basic</div>
        <div class="hc-best" id="basicBest">‚Äî</div>
        <div class="hc-avg" id="basicAvg">Avg: ‚Äî</div>
        <div class="hc-attempts" id="basicAttempts">0 attempts</div>
      </div>
      <div class="history-card intermediate">
        <div class="hc-level">Intermediate</div>
        <div class="hc-best" id="intermediateBest">‚Äî</div>
        <div class="hc-avg" id="intermediateAvg">Avg: ‚Äî</div>
        <div class="hc-attempts" id="intermediateAttempts">0 attempts</div>
      </div>
      <div class="history-card advanced">
        <div class="hc-level">Advanced</div>
        <div class="hc-best" id="advancedBest">‚Äî</div>
        <div class="hc-avg" id="advancedAvg">Avg: ‚Äî</div>
        <div class="hc-attempts" id="advancedAttempts">0 attempts</div>
      </div>
    </div>
    <div class="recent-attempts">
      <h3>Recent Attempts</h3>
      <div id="recentList"><div class="no-history">No attempts yet. Complete a quiz to see your history!</div></div>
    </div>
  </div>

  <!-- Level selector -->
  <div class="level-selector">
    <button class="level-btn basic" onclick="selectLevel('basic')">
      <span class="level-icon">üü¢</span>
      Basic
      <div class="level-label">Fundamentals</div>
    </button>
    <button class="level-btn intermediate" onclick="selectLevel('intermediate')">
      <span class="level-icon">üü°</span>
      Intermediate
      <div class="level-label">Proficiency</div>
    </button>
    <button class="level-btn advanced" onclick="selectLevel('advanced')">
      <span class="level-icon">üî¥</span>
      Advanced
      <div class="level-label">Expert Level</div>
    </button>
  </div>

  <div id="startScreen" class="start-screen">
    <p>Select a difficulty level above to begin.<br>Each test has <strong>10 questions</strong> ‚Äî one at a time with explanations. Your results are saved automatically.</p>
    <div style="margin-top:0.75rem">
      <span class="badge b">BASIC ‚Äî WebDriver, locators, assertions</span>
      <span class="badge i">INTERMEDIATE ‚Äî waits, POM, frameworks</span>
      <span class="badge a">ADVANCED ‚Äî parallel, CI/CD, CDP</span>
    </div>
  </div>

  <div id="progressInfo" class="progress-info" style="display:none">
    <span id="questionCount">Question 1 of 10</span>
    <span id="scoreTrack">Score: 0</span>
  </div>
  <div id="progressWrap" class="progress-bar-wrap" style="display:none">
    <div id="progressBar" class="progress-bar"></div>
  </div>

  <div id="questionCard" class="question-card" style="display:none"></div>


  <div id="scoreScreen" class="score-screen"></div>
</div>

<script>
// ‚îÄ‚îÄ SUPABASE INIT ‚îÄ‚îÄ
const { createClient } = supabase;
const sb = createClient(
  'https://pjppheqkapxpkerhgkov.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqcHBoZXFrYXB4cGtlcmhna292Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMjkxODksImV4cCI6MjA4NzgwNTE4OX0.TFdTWqivEcRjMARAqkTQPND5CXLvbDVyk0rlUCa8NVA'
);

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function switchTab(tab) {
  document.getElementById('loginTab').classList.toggle('active', tab === 'login');
  document.getElementById('signupTab').classList.toggle('active', tab === 'signup');
  document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const btn = document.getElementById('loginBtn');
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';

  if (!email || !password) { showError(errEl, 'Please fill in all fields.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner"></span>Signing in...';

  const { error } = await sb.auth.signInWithPassword({ email, password });
  btn.disabled = false;
  btn.textContent = 'Sign In';

  if (error) {
    // Give a friendly message for unverified email
    if (error.message.toLowerCase().includes('email not confirmed')) {
      showError(errEl, 'üìß Please verify your email first. Check your inbox for the confirmation link.');
    } else {
      showError(errEl, error.message);
    }
    return;
  }
  // session listener will handle redirect
}

async function handleSignup() {
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirm = document.getElementById('signupConfirm').value;
  const btn = document.getElementById('signupBtn');
  const errEl = document.getElementById('signupError');
  const sucEl = document.getElementById('signupSuccess');
  errEl.style.display = 'none';
  sucEl.style.display = 'none';

  if (!email || !password || !confirm) { showError(errEl, 'Please fill in all fields.'); return; }
  if (password.length < 6) { showError(errEl, 'Password must be at least 6 characters.'); return; }
  if (password !== confirm) { showError(errEl, 'Passwords do not match.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner"></span>Creating account...';

  const { data, error } = await sb.auth.signUp({ email, password });
  btn.disabled = false;
  btn.textContent = 'Create Account';

  if (error) { showError(errEl, error.message); return; }

  // Check if email confirmation is required
  if (data?.user?.identities?.length === 0) {
    showError(errEl, 'An account with this email already exists.');
    return;
  }

  if (data?.user?.confirmed_at) {
    // Email confirmation is disabled ‚Äî log straight in
    sucEl.textContent = '‚úÖ Account created! You can now sign in.';
    sucEl.style.display = 'block';
    setTimeout(() => switchTab('login'), 2000);
  } else {
    // Email confirmation is enabled ‚Äî show verification message
    sucEl.innerHTML = 'üìß <strong>Verification email sent!</strong><br>Please check your inbox and click the confirmation link before signing in.';
    sucEl.style.display = 'block';
    // Clear the form
    document.getElementById('signupEmail').value = '';
    document.getElementById('signupPassword').value = '';
    document.getElementById('signupConfirm').value = '';
  }
}

async function handleLogout() {
  try {
    const { error } = await sb.auth.signOut();
    if (error) {
      console.error('Sign out error:', error.message);
    }
    // Force UI reset regardless of error
    document.getElementById('authScreen').style.display = 'block';
    document.getElementById('appScreen').style.display = 'none';
    resetQuizUI();
    // Clear login fields
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').style.display = 'none';
    switchTab('login');
  } catch (e) {
    console.error('Logout failed:', e);
    // Force redirect to auth screen anyway
    document.getElementById('authScreen').style.display = 'block';
    document.getElementById('appScreen').style.display = 'none';
  }
}

function showError(el, msg) {
  el.textContent = msg;
  el.style.display = 'block';
}

// ‚îÄ‚îÄ SESSION LISTENER ‚îÄ‚îÄ
sb.auth.onAuthStateChange(async (event, session) => {
  if (session?.user) {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';
    document.getElementById('userEmail').textContent = session.user.email;
    await loadHistory();
  } else {
    document.getElementById('authScreen').style.display = 'block';
    document.getElementById('appScreen').style.display = 'none';
    resetQuizUI();
  }
});

// ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ
let historyOpen = false;

function toggleHistory() {
  historyOpen = !historyOpen;
  document.getElementById('historyPanel').classList.toggle('open', historyOpen);
  document.getElementById('historyArrow').textContent = historyOpen ? '‚ñ≤' : '‚ñº';
}

async function loadHistory() {
  const { data, error } = await sb
    .from('quiz_results')
    .select('*')
    .order('completed_at', { ascending: false });

  if (error || !data) return;

  // Compute stats per level
  const levels = ['basic', 'intermediate', 'advanced'];
  levels.forEach(level => {
    const rows = data.filter(r => r.level === level);
    const count = rows.length;
    const best = count > 0 ? Math.max(...rows.map(r => r.score)) : null;
    const avg = count > 0 ? (rows.reduce((s, r) => s + r.percentage, 0) / count).toFixed(1) : null;

    document.getElementById(`${level}Best`).textContent = best !== null ? `${best}/10` : '‚Äî';
    document.getElementById(`${level}Avg`).textContent = avg !== null ? `Avg: ${avg}%` : 'Avg: ‚Äî';
    document.getElementById(`${level}Attempts`).textContent = `${count} attempt${count !== 1 ? 's' : ''}`;
  });

  // Recent 8 attempts
  const recentList = document.getElementById('recentList');
  if (data.length === 0) {
    recentList.innerHTML = '<div class="no-history">No attempts yet. Complete a quiz to see your history!</div>';
    return;
  }

  recentList.innerHTML = data.slice(0, 8).map(r => {
    const d = new Date(r.completed_at);
    const dateStr = d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
    return `
      <div class="attempt-row">
        <span class="attempt-level ${r.level}">${r.level}</span>
        <span class="attempt-score">${r.score}/${r.total} (${r.percentage}%)</span>
        <span class="attempt-date">${dateStr}</span>
      </div>`;
  }).join('');
}

async function saveResult(level, score, total) {
  const percentage = parseFloat((score / total * 100).toFixed(2));
  const { data: { session } } = await sb.auth.getSession();
  if (!session) return;

  await sb.from('quiz_results').insert({
    user_id: session.user.id,
    level,
    score,
    total,
    percentage
  });

  await loadHistory();
}

// ‚îÄ‚îÄ QUIZ LOGIC ‚îÄ‚îÄ
let questions = {};         // loaded from Supabase
let currentLevel = null;
let currentIndex = 0;
let score = 0;
let answered = false;

async function selectLevel(level) {
  document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.level-btn.${level}`).classList.add('active');
  currentLevel = level;
  currentIndex = 0;
  score = 0;
  answered = false;

  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('scoreScreen').classList.remove('show');
  document.getElementById('progressInfo').style.display = 'flex';
  document.getElementById('progressWrap').style.display = 'block';
  document.getElementById('questionCard').style.display = 'none';

  // Show loading state
  document.getElementById('questionCard').innerHTML = `
    <div style="text-align:center; padding:2rem; color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:0.85rem;">
      <span class="loading-spinner"></span> Loading questions...
    </div>`;
  document.getElementById('questionCard').style.display = 'block';

  // Fetch questions from Supabase if not already loaded for this level
  if (!questions[level] || questions[level].length === 0) {
    const { data, error } = await sb
      .from('questions')
      .select('*')
      .eq('level', level)
      .order('created_at', { ascending: true });

    if (error || !data || data.length === 0) {
      document.getElementById('questionCard').innerHTML = `
        <div style="text-align:center; padding:2rem; color:var(--red); font-family:'JetBrains Mono',monospace; font-size:0.85rem;">
          ‚ùå Failed to load questions. Please try again.
        </div>`;
      return;
    }

    // Map Supabase columns to the shape loadQuestion() expects
    questions[level] = data.map(row => ({
      q: row.question_text,
      code: row.code_snippet || null,
      options: [row.option_a, row.option_b, row.option_c, row.option_d],
      answer: row.correct_answer,
      explanation: row.explanation
    }));
  }

  loadQuestion();
}

function loadQuestion() {
  const qs = questions[currentLevel];
  if (currentIndex >= qs.length) { showScore(); return; }

  answered = false;
  const q = qs[currentIndex];
  const letters = ['A', 'B', 'C', 'D'];

  document.getElementById('questionCount').textContent = `Question ${currentIndex + 1} of ${qs.length}`;
  document.getElementById('scoreTrack').textContent = `Score: ${score}`;
  document.getElementById('progressBar').style.width = `${(currentIndex / qs.length) * 100}%`;

  let codeBlock = q.code ? `<div class="code-block">${escHtml(q.code)}</div>` : '';
  let optHtml = q.options.map((o, i) => `
    <button class="option-btn" onclick="selectAnswer(${i})" id="opt${i}">
      <span class="opt-label">${letters[i]}</span><span>${o}</span>
    </button>`).join('');

  document.getElementById('questionCard').innerHTML = `
    <div class="question-tag">${currentLevel.toUpperCase()} ¬∑ Q${currentIndex + 1}</div>
    <div class="question-text">${q.q}</div>
    ${codeBlock}
    <div class="options">${optHtml}</div>
    <div class="explanation" id="explanation"></div>
    <button id="nextBtn" class="next-btn" onclick="nextQuestion()">Next Question ‚Üí</button>
  `;
  document.getElementById('questionCard').style.display = 'block';
  document.getElementById('nextBtn').classList.remove('show');

  // Scroll to top of question on new question load
  setTimeout(() => {
    document.getElementById('questionCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 50);
}

function selectAnswer(idx) {
  if (answered) return;
  answered = true;

  const q = questions[currentLevel][currentIndex]; // q.answer, q.explanation, q.options
  const opts = document.querySelectorAll('.option-btn');
  opts.forEach(b => b.disabled = true);

  const isCorrect = idx === q.answer;
  if (isCorrect) score++;

  opts[idx].classList.add(isCorrect ? 'correct' : 'wrong');
  if (!isCorrect) opts[q.answer].classList.add('correct');

  const exp = document.getElementById('explanation');
  exp.innerHTML = (isCorrect ? '‚úÖ <strong>Correct!</strong> ' : '‚ùå <strong>Incorrect.</strong> ') + q.explanation;
  exp.className = `explanation show ${isCorrect ? 'correct-exp' : 'wrong-exp'}`;

  document.getElementById('scoreTrack').textContent = `Score: ${score}`;

  const nextBtn = document.getElementById('nextBtn');
  nextBtn.textContent = currentIndex < questions[currentLevel].length - 1 ? 'Next Question ‚Üí' : 'See Results ‚Üí';
  nextBtn.classList.add('show');

  // Scroll next button into view
  setTimeout(() => {
    nextBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 150);
}

function nextQuestion() {
  currentIndex++;
  loadQuestion();
}

async function showScore() {
  document.getElementById('questionCard').style.display = 'none';
  document.getElementById('nextBtn').classList.remove('show');
  document.getElementById('progressBar').style.width = '100%';

  const total = questions[currentLevel].length;
  const pct = Math.round((score / total) * 100);
  const msg = pct >= 90 ? 'üèÜ Outstanding!' : pct >= 70 ? 'üëç Good Job!' : pct >= 50 ? 'üìö Keep Practicing' : 'üîÑ Review & Retry';
  const sub = pct >= 70 ? 'Consider moving to the next difficulty level.' : 'Review the explanations and try again.';

  document.getElementById('scoreScreen').innerHTML = `
    <div class="score-number">${score}/${total}</div>
    <div class="score-label">${pct}% correct ¬∑ ${currentLevel.toUpperCase()} level</div>
    <div class="score-msg">${msg}</div>
    <div class="score-sub">${sub}</div>
    <div class="score-saved" id="savingStatus">üíæ Saving result...</div>
    <div class="score-actions">
      <button class="restart-btn" onclick="selectLevel('${currentLevel}')">Retry This Test</button>
      <button class="restart-btn" onclick="resetQuizUI()">Choose Another Level</button>
    </div>
  `;
  document.getElementById('scoreScreen').classList.add('show');

  await saveResult(currentLevel, score, total);
  const el = document.getElementById('savingStatus');
  if (el) el.textContent = '‚úÖ Result saved to your profile!';
}

function resetQuizUI() {
  document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('startScreen').style.display = 'block';
  document.getElementById('scoreScreen').classList.remove('show');
  document.getElementById('questionCard').style.display = 'none';
  document.getElementById('progressInfo').style.display = 'none';
  document.getElementById('progressWrap').style.display = 'none';
  document.getElementById('nextBtn').classList.remove('show');
  currentLevel = null;
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
